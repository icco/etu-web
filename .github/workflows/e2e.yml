name: E2E Tests

on:
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          registry-url: "https://npm.pkg.github.com"
          scope: "@icco"

      - name: Install dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Playwright browsers
        run: yarn playwright install chromium --with-deps

      - name: Run E2E tests
        run: yarn test:e2e --update-snapshots
        env:
          CI: true
          E2E_MOCK: "true"
          GRPC_API_KEY: "test-api-key"
          NEXTAUTH_SECRET: "test-secret-for-e2e"

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-screenshots
          path: |
            e2e/**/*.png
            test-results/
            playwright-report/
          retention-days: 30

      - name: Find screenshots
        id: screenshots
        if: always()
        run: |
          echo "screenshots<<EOF" >> $GITHUB_OUTPUT
          find e2e -name "*.png" -type f | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with screenshots
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find all screenshot files
            const findScreenshots = (dir, files = []) => {
              if (!fs.existsSync(dir)) return files;
              const items = fs.readdirSync(dir);
              for (const item of items) {
                const fullPath = path.join(dir, item);
                if (fs.statSync(fullPath).isDirectory()) {
                  findScreenshots(fullPath, files);
                } else if (item.endsWith('.png')) {
                  files.push(fullPath);
                }
              }
              return files;
            };

            const screenshots = findScreenshots('e2e');

            if (screenshots.length === 0) {
              console.log('No screenshots found');
              return;
            }

            // Get artifact URL
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const screenshotArtifact = artifacts.artifacts.find(a => a.name === 'e2e-screenshots');
            const artifactUrl = screenshotArtifact
              ? `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${screenshotArtifact.id}`
              : `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = `## ðŸ“¸ E2E Screenshot Tests

            **${screenshots.length} screenshots** were captured during the E2E test run.

            ### Screenshots captured:
            ${screenshots.map(s => `- \`${s}\``).join('\n')}

            ðŸ“¦ [Download all screenshots](${artifactUrl})

            <sub>Generated by E2E workflow run [#${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('E2E Screenshot Tests')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
