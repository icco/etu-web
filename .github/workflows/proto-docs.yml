name: Generate Proto Documentation
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  packages: read

concurrency:
  group: "proto-docs"
  cancel-in-progress: false

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: yarn
          registry-url: https://npm.pkg.github.com
          scope: '@icco'

      - name: Install dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install protoc-gen-doc
        run: |
          wget https://github.com/pseudomuto/protoc-gen-doc/releases/download/v1.5.1/protoc-gen-doc_1.5.1_linux_amd64.tar.gz
          tar -xzf protoc-gen-doc_1.5.1_linux_amd64.tar.gz
          chmod +x protoc-gen-doc
          sudo mv protoc-gen-doc /usr/local/bin/

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Fetch proto source
        run: |
          mkdir -p /tmp/proto-temp /tmp/proto-include/google/protobuf
          curl -fsSL -o /tmp/proto-temp/etu.proto https://raw.githubusercontent.com/icco/etu-backend/main/proto/etu.proto
          curl -fsSL -o /tmp/proto-include/google/protobuf/timestamp.proto https://raw.githubusercontent.com/protocolbuffers/protobuf/main/src/google/protobuf/timestamp.proto

      - name: Generate documentation
        run: |
          mkdir -p public/docs
          protoc --doc_out=public/docs --doc_opt=html,index.html -I /tmp/proto-temp -I /tmp/proto-include /tmp/proto-temp/etu.proto

      - name: Commit and push generated docs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update proto documentation"
          file_pattern: "public/docs/*"
